<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="loti.poll.mapper.PollBankMapper">

	<sql id="selectGrinqBankQuestionBySearchDescListCommon">
		FROM TB_GRINQ_BANK_QUESTION A
		WHERE 1=1
			<if test="searchKey != ''">
				 AND QUESTION_GUBUN = #{searchKey} 
			</if>
			<if test="searchValue != ''">
				 AND QUESTION LIKE '%' || #{searchValue} || '%'
			</if>
		ORDER BY QUESTION_NO DESC
	</sql>
	<select id="selectGrinqBankQuestionBySearchDescListCount" parameterType="Map" resultType="Integer">
		<include refid="page.pageTotalCount"></include>
		<include refid="selectGrinqBankQuestionBySearchDescListCommon"></include>
	</select>
	<select id="selectGrinqBankQuestionBySearchDescList" parameterType="Map" resultType="DataMap">
		<include refid="page.pageHead"></include>
		<![CDATA[
			-- PollBankDAO.java
			-- 설문은행 문항 리스트
			SELECT   
				QUESTION_NO, QUESTION_CHECKED_NO, SAMP_CHECKED_NO, QUESTION,
				ANSWER_CNT, CHECKBOX_CHECKED_NO, QUESTION_GUBUN, QUESTION_COMM_GUBUN,
				(SELECT NVL(MAX(ANSWER_KIND), 0) FROM TB_GRINQ_BANK_SAMP WHERE QUESTION_NO = A.QUESTION_NO) ANSWER_KIND,
				(SELECT COUNT(1) FROM TB_GRINQ_BANK_QUESTION WHERE QUESTION_CHECKED_NO = A.QUESTION_NO) IS_REF
		]]>
		<include refid="selectGrinqBankQuestionBySearchDescListCommon"></include>
		<include refid="page.pageFoot"></include>
	</select>
	<select id="selectNotPagingGrinqBankQuestionBySearchDescList" parameterType="Integer" resultType="DataMap">
		<![CDATA[
			-- PollBankDAO.java
			-- 설문은행 문항 리스트
			SELECT   
				QUESTION_NO, QUESTION_CHECKED_NO, SAMP_CHECKED_NO, QUESTION,
				ANSWER_CNT, CHECKBOX_CHECKED_NO, QUESTION_GUBUN, QUESTION_COMM_GUBUN,
				(SELECT NVL(MAX(ANSWER_KIND), 0) FROM TB_GRINQ_BANK_SAMP WHERE QUESTION_NO = A.QUESTION_NO) ANSWER_KIND,
				(SELECT COUNT(1) FROM TB_GRINQ_BANK_QUESTION WHERE QUESTION_CHECKED_NO = A.QUESTION_NO) IS_REF
		FROM TB_GRINQ_BANK_QUESTION A
		WHERE 1=1
		 AND QUESTION_NO != #{value}
		ORDER BY QUESTION_NO DESC
		]]>
	</select>
		
	<select id="selectGrinqBankQuestionBySimpleList" parameterType="String" resultType="DataMap">
	<![CDATA[
		-- PollBankDAO.java
		-- 설문은행 문항 간단한 리스트
		SELECT
			QUESTION_NO, QUESTION_CHECKED_NO
		FROM TB_GRINQ_BANK_QUESTION
		WHERE 1=1
	]]>
			${value}
	</select>
	
	<update id="deleteGrinqBankSampByQuestionNo" parameterType="Integer">
	<![CDATA[
		-- PollBankDAO.java
		-- 설문은행 설문 보기 삭제
		DELETE FROM TB_GRINQ_BANK_SAMP
		WHERE QUESTION_NO = #{value}
	]]>
	</update>
	
	<update id="deleteGrinqBankQuestion" parameterType="Integer">
	<![CDATA[
		-- PollBankDAO.java
		-- 설문은행 설문 삭제
		DELETE FROM TB_GRINQ_BANK_QUESTION
		WHERE QUESTION_NO = #{value}
	]]>
	</update>
	
	<select id="selectGrinqBankSampList" parameterType="Integer" resultType="DataMap">
	<![CDATA[
		-- PollBankDAO.java
		-- 설문은행 설문의 보기 리스트
		SELECT
			QUESTION_NO, ANSWER_NO, ANSWER,
			ANSWER_KIND, LUSERNO
		FROM TB_GRINQ_BANK_SAMP
		WHERE QUESTION_NO = #{value}
		ORDER BY ANSWER_NO ASC
	]]>
	</select>
	
	<select id="selectGrinqBankQuestionMaxNo" resultType="Integer">
	<![CDATA[
		-- PollBankDAO.java
		-- 설문은행 설문 등록시 Max번호 추출
		SELECT 
			NVL(MAX(QUESTION_NO),0) + 1 AS QUESTION_NO
		FROM TB_GRINQ_BANK_QUESTION
	]]>
	</select>
	
	<update id="insertGrinqBankQuestion" parameterType="Map">
	<![CDATA[
		-- PollBankDAO.java
		-- 설문은행 설문 등록
		INSERT INTO TB_GRINQ_BANK_QUESTION
			(QUESTION_NO, QUESTION_CHECKED_NO, SAMP_CHECKED_NO,
			 QUESTION, ANSWER_CNT, CHECKBOX_CHECKED_NO,
			 QUESTION_GUBUN, LUSERNO, LDATE,
			 QUESTION_COMM_GUBUN)
		VALUES
			(#{questionNo}, #{questionCheckedNo}, #{sampCheckedNo},
			 ${question}, #{answerCnt}, #{checkboxCheckedNo},
			 #{questionGubun}, #{luserno}, SYSDATE,
			 #{questionCommGubun})
	]]>
	</update>
	
	<update id="insertGrqinqBankSamp" parameterType="Map">
	<![CDATA[
		-- PollBankDAO.java
		-- 설문은행 설문의 보기 등록
		INSERT INTO TB_GRINQ_BANK_SAMP (
		   QUESTION_NO, ANSWER_NO, 
		   ANSWER, ANSWER_KIND, LUSERNO, 
		   LDATE) 
		VALUES 
			( #{questionNo}, (SELECT NVL(MAX(ANSWER_NO), 0) +1 FROM TB_GRINQ_BANK_SAMP WHERE QUESTION_NO = #{questionNo}), 
			  #{answer}, #{answerKind}, #{luserno}, 
			  SYSDATE)
	]]>
	</update>
	
	<update id="updateGrinqBankQuestion" parameterType="Map">
	<![CDATA[
		-- PollBankDAO.java
		-- 설문은행 설문 수정
		UPDATE TB_GRINQ_BANK_QUESTION SET
			QUESTION_CHECKED_NO = #{questionCheckedNo},
			SAMP_CHECKED_NO = #{sampCheckedNo},
			QUESTION = ${question},
			ANSWER_CNT = #{answerCnt},
			CHECKBOX_CHECKED_NO = #{checkboxCheckedNo},
			QUESTION_GUBUN = #{questionGubun},
			LUSERNO = #{luserno},
			LDATE = SYSDATE,
			QUESTION_COMM_GUBUN = #{questionCommGubun}
		WHERE QUESTION_NO = #{questionNo}
	]]>
	</update>
	
</mapper>
