<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="loti.commonMgr.mapper.NoticeMapper">

	<select id="selectNoticeMaxNo" resultType="Integer">	
	<![CDATA[		
		-- 공지사항 입력시 필요한 최대 값 
		SELECT
			 max(seq) as max 
		FROM
			 tb_noti_pergrp 
	]]>
	</select>
	
	<update id="insertNotice" parameterType="Map">
	<![CDATA[
		-- 공지사항 입력 
		INSERT INTO 
			tb_noti_pergrp
			(seq,wuserno,username,title,content,visit,
			regdate,groupfile_no,noti_gubun,noti_part)
		VALUES
			(#{max},#{userNo},#{username},#{title},#{namoContent},0,sysdate,#{groupFileNo},#{notiGubun},#{notiPart})
	]]>
	</update>
	
	<update id="deleteNotice" parameterType="Map">
	<![CDATA[
		-- 공지사항 삭제
		DELETE
		FROM
			tb_noti_pergrp 
		WHERE
	]]>
		<if test="seq != null and seq != ''">
			seq= #{seq} and wuserno=#{wuserno}
		</if>
	
	</update>
	
	<update id="updateNotice" parameterType="Map">
	<![CDATA[		
		-- 공지사항 수정
		UPDATE 
			TB_NOTI_PERGRP
		SET
			TITLE        		=#{title},
			CONTENT        	=#{namoContent},
			noti_gubun		=#{notiGubun},
			noti_part			=#{notiPart},	
			GROUPFILE_NO	=#{groupFileNo}
		WHERE  
			SEQ		        	= #{seq}
	]]>
	</update>
	
	<sql id="selectSearchPerListCommon">
				FROM
		( 
			SELECT
    				a.dept as dept, deptnm, SCP.DEC_B64('KEY1',resno) as resno ,deptsub, mjiknm,  name, authority, a.userno as userno, nvl(c.gadmin, 8) gadmin, nvl(c.gadminnm, '교육생') as gadminnm 
			FROM
				    tb_member a left outer join tb_manager b  
				    on a.userno = b.userno 
				    left outer join tb_gadmin c 
				    on b.gadmin = c.gadmin   
				    <choose>
						   <when test="searchKey == ('8').toString() or searchKey == 'ALL'">
						   		<if test="searchValue != '' and searchText != ''">
						   			WHERE ${searchValue} like '%' || #{searchText} || '%'
						   		</if>
						   </when>
				    		<otherwise>
				    		</otherwise>
				    </choose>
		) A 
			
			WHERE 
				1=1
		    		<choose>
						   <when test="searchKey == ('8').toString() or searchKey == 'ALL'">
						   </when>
				    		<otherwise>
				    			AND gadmin = #{searchKey}
				    			<if test="searchValue != '' and searchText != ''">
				    				AND  ${searchValue} like '%' || #{searchText} || '%'
				    			</if>
				    		</otherwise>
				    </choose>
			ORDER BY
				 dept, name 	
				 
	</sql>
	<select id="selectSearchPerListCount" parameterType="Map" resultType="Integer">
		<include refid="page.pageTotalCount"></include>
		<include refid="selectSearchPerListCommon"></include>
	</select>
	<select id="selectSearchPerList" parameterType="Map" resultType="ut.lib.support.DataMap">
		<include refid="page.pageHead"></include>
	<![CDATA[
		-- 개인별 공지 대상자 리스트 뽑아오기.
		SELECT 
			dept, deptnm, SCP.DEC_B64('KEY1',resno) as resno ,deptsub, mjiknm,  name, authority, userno, gadmin, gadminnm 
	]]>
		<include refid="selectSearchPerListCommon"></include>
		<include refid="page.pageFoot"></include>
	</select>
	
	<sql id="selectNotiPerGrpListCommon">
		FROM TB_NOTI_PERGRP
		WHERE 1=1
			<if test="searchValue != ''">
				<if test="searchKey != ''">
					AND TITLE LIKE '%' || #{searchValue} || '%' OR CONTENT LIKE '%' || #{searchValue} || '%'
				</if>
				<if test="searchKey == ''">
					AND ${searchKey} LIKE '%' || #{searchValue} || '%'
				</if>
			</if>
			<if test="userNo != ''">
				AND WUSERNO = #{userNo}
			</if>
		ORDER BY SEQ DESC
	</sql>
	<select id="selectNotiPerGrpListCount" parameterType="Map" resultType="Integer">
		<include refid="page.pageTotalCount"></include>
		<include refid="selectNotiPerGrpListCommon"></include>
	</select>
	<select id="selectNotiPerGrpList" parameterType="Map" resultType="ut.lib.support.DataMap">
		<include refid="page.pageHead"></include>
	<![CDATA[
		-- 개인 그룹 공지 관리 리스트
		SELECT 
			SEQ, TITLE, WUSERNO, USERNAME, 
			REGDATE, VISIT, NOTI_GUBUN, GROUPFILE_NO, NOTI_PART
	]]>
		<include refid="selectNotiPerGrpListCommon"></include>
		<include refid="page.pageFoot"></include>
	</select>
	
	
	<select id="selectNotiPerGrpRow" parameterType="Integer" resultMap="common.clobContent">
	<![CDATA[
		-- 개인 그룹 공지 관리 상세내용
		SELECT 
			SEQ, TITLE, CONTENT, WUSERNO, USERNAME, 
			REGDATE, VISIT, NOTI_GUBUN, GROUPFILE_NO, NOTI_PART 
		FROM TB_NOTI_PERGRP 
		WHERE SEQ = #{value}
	]]>
	</select>
	
	<select id="searchName" parameterType="String" resultType="ut.lib.support.DataMap">
	<![CDATA[
		-- 이름 검색 
		SELECT 
			name 
		FROM
			tb_member 
		WHERE userno = #{value}
	]]>	
	</select>
	
	<update id="updateNotiPerGrpVisitCnt" parameterType="Integer">
	<![CDATA[
		-- 개인 그룹 공지 관리 상세내용
		UPDATE TB_NOTI_PERGRP SET 
			VISIT= VISIT+1 
		WHERE SEQ = #{value}
	]]>
	</update>

</mapper>
